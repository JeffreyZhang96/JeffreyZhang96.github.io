<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>基础知识</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.4.0">
    
    
    <link rel="preload" href="/assets/css/0.styles.57314520.css" as="style"><link rel="preload" href="/assets/js/app.8e528a8b.js" as="script"><link rel="preload" href="/assets/js/3.82a49c19.js" as="script"><link rel="preload" href="/assets/js/1.0ab98803.js" as="script"><link rel="preload" href="/assets/js/16.695eba2a.js" as="script"><link rel="prefetch" href="/assets/js/10.0d102bea.js"><link rel="prefetch" href="/assets/js/11.5e4a2761.js"><link rel="prefetch" href="/assets/js/12.aef8f1f6.js"><link rel="prefetch" href="/assets/js/13.5b2c2445.js"><link rel="prefetch" href="/assets/js/14.9521dcbd.js"><link rel="prefetch" href="/assets/js/15.fa9dfeb1.js"><link rel="prefetch" href="/assets/js/17.a39d0ec9.js"><link rel="prefetch" href="/assets/js/18.b8b9dd64.js"><link rel="prefetch" href="/assets/js/19.d5b22499.js"><link rel="prefetch" href="/assets/js/20.b157b0b0.js"><link rel="prefetch" href="/assets/js/21.a122ea90.js"><link rel="prefetch" href="/assets/js/22.7fa65ea5.js"><link rel="prefetch" href="/assets/js/23.a95127d1.js"><link rel="prefetch" href="/assets/js/24.4c905bc9.js"><link rel="prefetch" href="/assets/js/25.231023bd.js"><link rel="prefetch" href="/assets/js/26.3968f588.js"><link rel="prefetch" href="/assets/js/27.bf6ef3e7.js"><link rel="prefetch" href="/assets/js/28.076b9ccc.js"><link rel="prefetch" href="/assets/js/29.dae1a67e.js"><link rel="prefetch" href="/assets/js/30.4257dfcc.js"><link rel="prefetch" href="/assets/js/31.685a3d09.js"><link rel="prefetch" href="/assets/js/32.b518b57c.js"><link rel="prefetch" href="/assets/js/4.542f8749.js"><link rel="prefetch" href="/assets/js/5.300a1aac.js"><link rel="prefetch" href="/assets/js/6.e09b9417.js"><link rel="prefetch" href="/assets/js/7.84bad2f8.js"><link rel="prefetch" href="/assets/js/8.4fe02f1b.js"><link rel="prefetch" href="/assets/js/9.6d6b0fe4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.57314520.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-418054de><div data-v-418054de><div id="loader-wrapper" class="loading-wrapper" data-v-71fac282 data-v-418054de data-v-418054de><div class="loader-main" data-v-71fac282><div data-v-71fac282></div><div data-v-71fac282></div><div data-v-71fac282></div><div data-v-71fac282></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-5d8855ac data-v-418054de data-v-418054de><h3 class="title" style="display:none;" data-v-5d8855ac data-v-5d8855ac></h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-5d8855ac data-v-5d8855ac><input type="password" value="" data-v-5d8855ac> <span data-v-5d8855ac>Konck! Knock!</span> <button data-v-5d8855ac>OK</button></label> <div class="footer" style="display:none;" data-v-5d8855ac data-v-5d8855ac><span data-v-5d8855ac><i class="iconfont reco-theme" data-v-5d8855ac></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-5d8855ac>vuePress-theme-reco</a></span> <span data-v-5d8855ac><i class="iconfont reco-copyright" data-v-5d8855ac></i> <a data-v-5d8855ac><!---->
            
          <!---->
          2020
        </a></span></div></div> <div class="hide" data-v-418054de><header class="navbar" data-v-418054de><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="" class="logo"> <!----></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      基础
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/HTML/" class="nav-link"><i class="iconfont undefined"></i>
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/CSS/" class="nav-link"><i class="iconfont undefined"></i>
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/JavaScript/" class="nav-link"><i class="iconfont undefined"></i>
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/TypeScript/" class="nav-link"><i class="iconfont undefined"></i>
  TypeScript
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      通识
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/算法/" class="nav-link"><i class="iconfont undefined"></i>
  算法
</a></li><li class="dropdown-item"><!----> <a href="/网络/" class="nav-link"><i class="iconfont undefined"></i>
  网络
</a></li><li class="dropdown-item"><!----> <a href="/浏览器/" class="nav-link"><i class="iconfont undefined"></i>
  浏览器
</a></li><li class="dropdown-item"><!----> <a href="/操作系统/" class="nav-link"><i class="iconfont undefined"></i>
  操作系统
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      框架
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Vue/" class="nav-link"><i class="iconfont undefined"></i>
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/React/" class="nav-link"><i class="iconfont undefined"></i>
  React
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      高级
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/NodeJS/" class="nav-link router-link-exact-active router-link-active"><i class="iconfont undefined"></i>
  NodeJS
</a></li><li class="dropdown-item"><!----> <a href="/数据库/" class="nav-link"><i class="iconfont undefined"></i>
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/优化/" class="nav-link"><i class="iconfont undefined"></i>
  优化
</a></li><li class="dropdown-item"><!----> <a href="/安全/" class="nav-link"><i class="iconfont undefined"></i>
  安全
</a></li><li class="dropdown-item"><!----> <a href="/图形/" class="nav-link"><i class="iconfont undefined"></i>
  图形
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      工具
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/webpack/" class="nav-link"><i class="iconfont undefined"></i>
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/git/" class="nav-link"><i class="iconfont undefined"></i>
  git
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      项目
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mimall/" class="nav-link"><i class="iconfont undefined"></i>
  vue-mimall
</a></li><li class="dropdown-item"><!----> <a href="/weibo/" class="nav-link"><i class="iconfont undefined"></i>
  koa2-weibo
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/JeffreyZhang96" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-418054de></div> <aside class="sidebar" data-v-418054de><div class="personal-info-wrapper" data-v-949f496c><!----> <!----> <div class="num" data-v-949f496c><div data-v-949f496c><h3 data-v-949f496c>0</h3> <h6 data-v-949f496c>Article</h6></div> <div data-v-949f496c><h3 data-v-949f496c>0</h3> <h6 data-v-949f496c>Tag</h6></div></div> <hr data-v-949f496c></div> <nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      基础
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/HTML/" class="nav-link"><i class="iconfont undefined"></i>
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/CSS/" class="nav-link"><i class="iconfont undefined"></i>
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/JavaScript/" class="nav-link"><i class="iconfont undefined"></i>
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/TypeScript/" class="nav-link"><i class="iconfont undefined"></i>
  TypeScript
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      通识
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/算法/" class="nav-link"><i class="iconfont undefined"></i>
  算法
</a></li><li class="dropdown-item"><!----> <a href="/网络/" class="nav-link"><i class="iconfont undefined"></i>
  网络
</a></li><li class="dropdown-item"><!----> <a href="/浏览器/" class="nav-link"><i class="iconfont undefined"></i>
  浏览器
</a></li><li class="dropdown-item"><!----> <a href="/操作系统/" class="nav-link"><i class="iconfont undefined"></i>
  操作系统
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      框架
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Vue/" class="nav-link"><i class="iconfont undefined"></i>
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/React/" class="nav-link"><i class="iconfont undefined"></i>
  React
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      高级
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/NodeJS/" class="nav-link router-link-exact-active router-link-active"><i class="iconfont undefined"></i>
  NodeJS
</a></li><li class="dropdown-item"><!----> <a href="/数据库/" class="nav-link"><i class="iconfont undefined"></i>
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/优化/" class="nav-link"><i class="iconfont undefined"></i>
  优化
</a></li><li class="dropdown-item"><!----> <a href="/安全/" class="nav-link"><i class="iconfont undefined"></i>
  安全
</a></li><li class="dropdown-item"><!----> <a href="/图形/" class="nav-link"><i class="iconfont undefined"></i>
  图形
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      工具
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/webpack/" class="nav-link"><i class="iconfont undefined"></i>
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/git/" class="nav-link"><i class="iconfont undefined"></i>
  git
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      项目
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mimall/" class="nav-link"><i class="iconfont undefined"></i>
  vue-mimall
</a></li><li class="dropdown-item"><!----> <a href="/weibo/" class="nav-link"><i class="iconfont undefined"></i>
  koa2-weibo
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/JeffreyZhang96" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>基础知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/NodeJS/#基础知识" class="sidebar-link">基础知识</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/NodeJS/#nodejs-特点" class="sidebar-link">NodeJS 特点</a></li></ul></li><li><a href="/NodeJS/#基本模块" class="sidebar-link">基本模块</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/NodeJS/#global" class="sidebar-link">global</a></li><li class="sidebar-sub-header"><a href="/NodeJS/#process" class="sidebar-link">process</a></li><li class="sidebar-sub-header"><a href="/NodeJS/#fs" class="sidebar-link">fs</a></li><li class="sidebar-sub-header"><a href="/NodeJS/#stream" class="sidebar-link">stream</a></li><li class="sidebar-sub-header"><a href="/NodeJS/#http" class="sidebar-link">http</a></li><li class="sidebar-sub-header"><a href="/NodeJS/#crypto" class="sidebar-link">crypto</a></li></ul></li><li><a href="/NodeJS/#事件轮询" class="sidebar-link">事件轮询</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/NodeJS/#node-中的-event-loop" class="sidebar-link">Node 中的 Event Loop</a></li><li class="sidebar-sub-header"><a href="/NodeJS/#node-与浏览器的-event-loop-差异" class="sidebar-link">Node 与浏览器的 Event Loop 差异</a></li></ul></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-5d8855ac data-v-418054de><h3 class="title" style="display:none;" data-v-5d8855ac data-v-5d8855ac></h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-5d8855ac data-v-5d8855ac><input type="password" value="" data-v-5d8855ac> <span data-v-5d8855ac>Konck! Knock!</span> <button data-v-5d8855ac>OK</button></label> <div class="footer" style="display:none;" data-v-5d8855ac data-v-5d8855ac><span data-v-5d8855ac><i class="iconfont reco-theme" data-v-5d8855ac></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-5d8855ac>vuePress-theme-reco</a></span> <span data-v-5d8855ac><i class="iconfont reco-copyright" data-v-5d8855ac></i> <a data-v-5d8855ac><!---->
            
          <!---->
          2020
        </a></span></div></div> <div data-v-418054de><main class="page"><div class="page-title" style="display:none;"><h1>基础知识</h1> <hr> <div data-v-0608c411><!----> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default" style="display:none;"><h2 id="基础知识"><a href="#基础知识" class="header-anchor">#</a> <strong>基础知识</strong></h2> <h3 id="nodejs-特点"><a href="#nodejs-特点" class="header-anchor">#</a> NodeJS 特点</h3> <ul><li>非阻塞式的异步 I/O
<ul><li>Node.js 中采用了非阻塞型 I/O 机制，因此在执行了访问文件的代码之后，Nodejs 不会阻塞在那里等待文件获取完成，而是把这件事交给底层操作系统，使用回调函数的方式来处理异步的 IO，立即转而执行其它的代码，</li></ul></li> <li>事件轮询
<ul><li>Nodejs 接收到的事件会放到事件队列中，而不是立即执行它，当 NodeJS 当前代码执行完后他会检查事件队列中是否有事件，如果有，他会取出来依次执行</li></ul></li> <li>单线程
<ul><li>Node.js 不为每个客户连接创建一个新的线程，而仅仅使用一个线程。当有用户连接了，就触发一个内部事件，通过非阻塞 I/O、事件驱动机制，让 Node.js 程序宏观上也是并行的</li> <li>优点：不会死锁、不用像多线程那样处处在意同步问题、没有线程切换带来的性能上的开销</li> <li>缺点：多核 CPU 需单独开子线程、错误会使得整个应用退出、大量计算会占用 CPU 从而无法调用异步 I/O</li></ul></li> <li>擅长 I/O 密集型
<ul><li>主要体现在 Node 利用事件轮询的方式处理事件，而不是单开一个线程来为每一个请求服务</li></ul></li> <li>不擅长 CPU 密集型业务
<ul><li>由于 Node 单线程，如果长时间运行计算将导致 CPU 不能释放，使得后续 I/O 无法发起。（解决办法是分解大型运算为多个小任务，不阻塞 I/O 发起）</li></ul></li></ul> <h4 id="global-对象"><a href="#global-对象" class="header-anchor">#</a> global 对象</h4> <p>与在浏览器端不同，浏览器端将希望全局访问的对象挂到 window 上，而 nodejs 则将希望全局访问的对象挂到 global 对象上</p> <ul><li>CommonJS</li> <li>Buffer、process、console</li> <li>timer 定时器相关</li></ul> <h4 id="setimmediate-、settimeout-fn-0-与-process-nexttick"><a href="#setimmediate-、settimeout-fn-0-与-process-nexttick" class="header-anchor">#</a> setImmediate()、setTimeout(fn, 0) 与 process.nextTick()</h4> <p>两个都是传入一个回调函数，当同步事件执行完之后马上执行。</p> <p>执行顺序依次是：</p> <ul><li>process.nextTick()
<ul><li>将回调函数加入到 当前执行栈的尾部，任务队列之前</li></ul></li> <li>setTimeout(fn, 0)
<ul><li>回调函数加入到 任务队列尾部。即使是 0，也会又 4ms 的延时</li></ul></li> <li>setImmediate()
<ul><li>将回调函数插入到任务队列的最末尾，也不会造成阻塞，但不妨碍其他的异步事件</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;setImmediate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;setImmediate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;next&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="基本模块"><a href="#基本模块" class="header-anchor">#</a> <strong>基本模块</strong></h2> <h3 id="global"><a href="#global" class="header-anchor">#</a> global</h3> <p>JavaScript 有且仅有一个全局对象，在浏览器中，叫 window 对象。而在 Node.js 环境中，也有唯一的全局对象，但不叫 window，而叫 global，这个对象的属性和方法也和浏览器环境的 window 不同。进入 Node.js 交互环境，可以直接输入：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&gt;</span> global<span class="token punctuation">.</span>console
Console <span class="token punctuation">{</span>
  log<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> bound <span class="token punctuation">]</span><span class="token punctuation">,</span>
  info<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> bound <span class="token punctuation">]</span><span class="token punctuation">,</span>
  warn<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> bound <span class="token punctuation">]</span><span class="token punctuation">,</span>
  error<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> bound <span class="token punctuation">]</span><span class="token punctuation">,</span>
  dir<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> bound <span class="token punctuation">]</span><span class="token punctuation">,</span>
  time<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> bound <span class="token punctuation">]</span><span class="token punctuation">,</span>
  timeEnd<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> bound <span class="token punctuation">]</span><span class="token punctuation">,</span>
  trace<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> bound trace<span class="token punctuation">]</span><span class="token punctuation">,</span>
  assert<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> bound <span class="token punctuation">]</span><span class="token punctuation">,</span>
  Console<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> Console<span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre></div><h3 id="process"><a href="#process" class="header-anchor">#</a> process</h3> <p>process 也是 Node.js 提供的一个对象，它代表当前 Node.js 进程。通过 process 对象可以拿到许多有用信息：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&gt;</span> process <span class="token operator">===</span> global<span class="token punctuation">.</span>process<span class="token punctuation">;</span>
<span class="token boolean">true</span>
<span class="token operator">&gt;</span> process<span class="token punctuation">.</span>version<span class="token punctuation">;</span>
<span class="token string">'v5.2.0'</span>
<span class="token operator">&gt;</span> process<span class="token punctuation">.</span>platform<span class="token punctuation">;</span>
<span class="token string">'darwin'</span>
<span class="token operator">&gt;</span> process<span class="token punctuation">.</span>arch<span class="token punctuation">;</span>
<span class="token string">'x64'</span>
<span class="token operator">&gt;</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回当前工作目录</span>
<span class="token string">'/Users/michael'</span>
<span class="token operator">&gt;</span> process<span class="token punctuation">.</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">'/private/tmp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 切换当前工作目录</span>
<span class="token keyword">undefined</span>
<span class="token operator">&gt;</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token string">'/private/tmp'</span>
</code></pre></div><p>JavaScript 程序是由事件驱动执行的单线程模型，Node.js 也不例外。Node.js 不断执行响应事件的 JavaScript 函数，直到没有任何响应事件的函数可以执行时，Node.js 就退出了。</p> <p>如果我们想要在下一次事件响应中执行代码，可以调用 process.nextTick()：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// test.js</span>

<span class="token comment">// process.nextTick()将在下一轮事件循环中调用:</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;nextTick callback!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;nextTick was set!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>用 Node 执行上面的代码 node test.js，你会看到，打印输出是：</p> <div class="language-js extra-class"><pre class="language-js"><code>nextTick was <span class="token keyword">set</span><span class="token operator">!</span>
nextTick callback<span class="token operator">!</span>
</code></pre></div><p>这说明传入 process.nextTick()的函数不是立刻执行，而是要等到下一次事件循环。</p> <p>Node.js 进程本身的事件就由 process 对象来处理。如果我们响应 exit 事件，就可以在程序即将退出时执行某个回调函数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 程序即将退出时的回调函数:</span>
process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;exit&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;about to exit with code: &quot;</span> <span class="token operator">+</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>判断 JavaScript 执行环境</p> <p>有很多 JavaScript 代码既能在浏览器中执行，也能在 Node 环境执行，但有些时候，程序本身需要判断自己到底是在什么环境下执行的，常用的方式就是根据浏览器和 Node 环境提供的全局变量名称来判断：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> window <span class="token operator">===</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;node.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;browser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="fs"><a href="#fs" class="header-anchor">#</a> fs</h3> <p>Node.js 内置的 fs 模块就是文件系统模块，负责读写文件。</p> <p>和所有其它 JavaScript 模块不同的是，fs 模块同时提供了异步和同步的方法。</p> <p>回顾一下什么是异步方法。因为 JavaScript 的单线程模型，执行 IO 操作时，JavaScript 代码无需等待，而是传入回调函数后，继续执行后续 JavaScript 代码。比如 jQuery 提供的 getJSON()操作：</p> <div class="language-js extra-class"><pre class="language-js"><code>$<span class="token punctuation">.</span><span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token string">&quot;http://example.com/ajax&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;IO 结果返回后执行...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;不等待 IO 结果直接执行后续代码...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>而同步的 IO 操作则需要等待函数返回：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 根据网络耗时，函数将执行几十毫秒~几秒不等:</span>
<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token function">getJSONSync</span><span class="token punctuation">(</span><span class="token string">&quot;http://example.com/ajax&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>同步操作的好处是代码简单，缺点是程序将等待 IO 操作，在等待时间内，无法响应其它任何事件。而异步读取不用等待 IO 操作，但代码较麻烦。</p> <h4 id="异步读文件"><a href="#异步读文件" class="header-anchor">#</a> 异步读文件</h4> <p>按照 JavaScript 的标准，异步读取一个文本文件的代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;sample.txt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>请注意，sample.txt 文件必须在当前目录下，且文件编码为 utf-8。</p> <p>异步读取时，传入的回调函数接收两个参数，当正常读取时，err 参数为 null，data 参数为读取到的 String。当读取发生错误时，err 参数代表一个错误对象，data 为 undefined。这也是 Node.js 标准的回调函数：第一个参数代表错误信息，第二个参数代表结果。后面我们还会经常编写这种回调函数。</p> <p>由于 err 是否为 null 就是判断是否出错的标志，所以通常的判断逻辑总是：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 出错了</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 正常</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果我们要读取的文件不是文本文件，而是二进制文件，怎么办？</p> <p>下面的例子演示了如何读取一个图片文件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;sample.png&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">&quot; bytes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>当读取二进制文件时，不传入文件编码时，回调函数的 data 参数将返回一个 Buffer 对象。在 Node.js 中，Buffer 对象就是一个包含零个或任意个字节的数组（注意和 Array 不同）。</p> <p>Buffer 对象可以和 String 作转换，例如，把一个 Buffer 对象转换成 String：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Buffer -&gt; String</span>
<span class="token keyword">var</span> text <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>或者把一个 String 转换成 Buffer：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// String -&gt; Buffer</span>
<span class="token keyword">var</span> buf <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="同步读文件"><a href="#同步读文件" class="header-anchor">#</a> 同步读文件</h4> <p>除了标准的异步读取模式外，fs 也提供相应的同步读取函数。同步读取的函数和异步函数相比，多了一个 Sync 后缀，并且不接收回调函数，函数直接返回结果。</p> <p>用 fs 模块同步读取一个文本文件的代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> data <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">&quot;sample.txt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可见，原异步调用的回调函数的 data 被函数直接返回，函数名需要改为 readFileSync，其它参数不变。</p> <p>如果同步读取文件发生错误，则需要用 try...catch 捕获该错误：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> data <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">&quot;sample.txt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 出错了</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="写文件"><a href="#写文件" class="header-anchor">#</a> 写文件</h4> <p>将数据写入文件是通过 fs.writeFile()实现的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token string">&quot;Hello, Node.js&quot;</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">&quot;output.txt&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;ok.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>writeFile()的参数依次为文件名、数据和回调函数。如果传入的数据是 String，默认按 UTF-8 编码写入文本文件，如果传入的参数是 Buffer，则写入的是二进制文件。回调函数由于只关心成功与否，因此只需要一个 err 参数。</p> <p>和 readFile()类似，writeFile()也有一个同步方法，叫 writeFileSync()：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token string">&quot;Hello, Node.js&quot;</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">&quot;output.txt&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="stat"><a href="#stat" class="header-anchor">#</a> stat</h4> <p>如果我们要获取文件大小，创建时间等信息，可以使用 fs.stat()，它返回一个 Stat 对象，能告诉我们文件或目录的详细信息：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span><span class="token string">&quot;sample.txt&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stat</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 是否是文件:</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;isFile: &quot;</span> <span class="token operator">+</span> stat<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 是否是目录:</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;isDirectory: &quot;</span> <span class="token operator">+</span> stat<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stat<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 文件大小:</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;size: &quot;</span> <span class="token operator">+</span> stat<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 创建时间, Date 对象:</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;birth time: &quot;</span> <span class="token operator">+</span> stat<span class="token punctuation">.</span>birthtime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 修改时间, Date 对象:</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;modified time: &quot;</span> <span class="token operator">+</span> stat<span class="token punctuation">.</span>mtime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>运行结果如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>isFile<span class="token operator">:</span> <span class="token boolean">true</span>
isDirectory<span class="token operator">:</span> <span class="token boolean">false</span>
size<span class="token operator">:</span> <span class="token number">181</span>
birth time<span class="token operator">:</span> Fri Dec <span class="token number">11</span> <span class="token number">2015</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">41</span> <span class="token constant">GMT</span><span class="token operator">+</span><span class="token number">0800</span> <span class="token punctuation">(</span><span class="token constant">CST</span><span class="token punctuation">)</span>
modified time<span class="token operator">:</span> Fri Dec <span class="token number">11</span> <span class="token number">2015</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">00</span> <span class="token constant">GMT</span><span class="token operator">+</span><span class="token number">0800</span> <span class="token punctuation">(</span><span class="token constant">CST</span><span class="token punctuation">)</span>
</code></pre></div><p>stat()也有一个对应的同步函数 statSync()，请试着改写上述异步代码为同步代码。</p> <h4 id="异步还是同步"><a href="#异步还是同步" class="header-anchor">#</a> 异步还是同步</h4> <p>在 fs 模块中，提供同步方法是为了方便使用。那我们到底是应该用异步方法还是同步方法呢？</p> <p>由于 Node 环境执行的 JavaScript 代码是服务器端代码，所以，绝大部分需要在服务器运行期反复执行业务逻辑的代码，必须使用异步代码，否则，同步代码在执行时期，服务器将停止响应，因为 JavaScript 只有一个执行线程。</p> <p>服务器启动时如果需要读取配置文件，或者结束时需要写入到状态文件时，可以使用同步代码，因为这些代码只在启动和结束时执行一次，不影响服务器正常运行时的异步执行。</p> <h3 id="stream"><a href="#stream" class="header-anchor">#</a> stream</h3> <h3 id="http"><a href="#http" class="header-anchor">#</a> http</h3> <h3 id="crypto"><a href="#crypto" class="header-anchor">#</a> crypto</h3> <h2 id="事件轮询"><a href="#事件轮询" class="header-anchor">#</a> <strong>事件轮询</strong></h2> <h3 id="node-中的-event-loop"><a href="#node-中的-event-loop" class="header-anchor">#</a> Node 中的 Event Loop</h3> <hr> <h4 id="_1-node-简介"><a href="#_1-node-简介" class="header-anchor">#</a> 1.Node 简介</h4> <p>Node 中的 Event Loop 和浏览器中的是完全不相同的东西。Node.js 采用 V8 作为 js 的解析引擎，而 I/O 处理方面使用了自己设计的 libuv，libuv 是一个基于事件驱动的跨平台抽象层，封装了不同操作系统一些底层特性，对外提供统一的 API，事件循环机制也是它里面的实现（下文会详细介绍）。</p> <p><img src="https://camo.githubusercontent.com/58779606d55020cd7c815402ccdaea48dcd94aec/68747470733a2f2f757365722d676f6c642d63646e2e786974752e696f2f323031392f312f31312f313638336438313637346630373665623f773d35343326683d32323326663d706e6726733d3831373535" alt=""></p> <ul><li>V8 引擎解析 JavaScript 脚本。</li> <li>解析后的代码，调用 Node API。</li> <li>libuv 库负责 Node API 的执行。它将不同的任务分配给不同的线程，形成一个 Event Loop（事件循环），以异步的方式将任务的执行结果返回给 V8 引擎。</li> <li>V8 引擎再将结果返回给用户。</li></ul> <h4 id="_2-六个阶段"><a href="#_2-六个阶段" class="header-anchor">#</a> 2.六个阶段</h4> <p>其中 libuv 引擎中的事件循环分为 6 个阶段，它们会按照顺序反复运行。每当进入某一个阶段的时候，都会从对应的回调队列中取出函数去执行。当队列为空或者执行的回调函数数量到达系统设定的阈值，就会进入下一阶段。</p> <p><img src="https://camo.githubusercontent.com/992acfd5750f98c9a56a9a96e95111bdf7cc7669/68747470733a2f2f757365722d676f6c642d63646e2e786974752e696f2f323031392f312f31322f313638343162643938363063316565393f773d33353926683d33333126663d706e6726733d3130353037" alt=""></p> <p>从上图中，大致看出 node 中的事件循环的顺序：</p> <p>外部输入数据--&gt;轮询阶段(poll)--&gt;检查阶段(check)--&gt;关闭事件回调阶段(close callback)--&gt;定时器检测阶段(timer)--&gt;I/O 事件回调阶段(I/O callbacks)--&gt;闲置阶段(idle, prepare)--&gt;轮询阶段（按照该顺序反复运行）...</p> <ul><li>timers 阶段：这个阶段执行 timer（setTimeout、setInterval）的回调</li> <li>I/O callbacks 阶段：处理一些上一轮循环中的少数未执行的 I/O 回调</li> <li>idle, prepare 阶段：仅 node 内部使用</li> <li>poll 阶段：获取新的 I/O 事件, 适当的条件下 node 将阻塞在这里</li> <li>check 阶段：执行 setImmediate() 的回调</li> <li>close callbacks 阶段：执行 socket 的 close 事件回调</li></ul> <p>注意：<strong>上面六个阶段都不包括 process.nextTick()</strong>(下文会介绍)</p> <p>接下去我们详细介绍<code>timers</code>、<code>poll</code>、<code>check</code>这 3 个阶段，因为日常开发中的绝大部分异步任务都是在这 3 个阶段处理的。</p> <h5 id="_1-timer"><a href="#_1-timer" class="header-anchor">#</a> (1) timer</h5> <p>timers 阶段会执行 setTimeout 和 setInterval 回调，并且是由 poll 阶段控制的。<br>
同样，<strong>在 Node 中定时器指定的时间也不是准确时间，只能是尽快执行</strong>。</p> <h5 id="_2-poll"><a href="#_2-poll" class="header-anchor">#</a> (2) poll</h5> <p>poll 是一个至关重要的阶段，这一阶段中，系统会做两件事情</p> <p>1.回到 timer 阶段执行回调</p> <p>2.执行 I/O 回调</p> <p>并且在进入该阶段时如果没有设定了 timer 的话，会发生以下两件事情</p> <ul><li>如果 poll 队列不为空，会遍历回调队列并同步执行，直到队列为空或者达到系统限制</li> <li>如果 poll 队列为空时，会有两件事发生
<ul><li>如果有 setImmediate 回调需要执行，poll 阶段会停止并且进入到 check 阶段执行回调</li> <li>如果没有 setImmediate 回调需要执行，会等待回调被加入到队列中并立即执行回调，这里同样会有个超时时间设置防止一直等待下去</li></ul></li></ul> <p>当然设定了 timer 的话且 poll 队列为空，则会判断是否有 timer 超时，如果有的话会回到 timer 阶段执行回调。</p> <h5 id="_3-check-阶段"><a href="#_3-check-阶段" class="header-anchor">#</a> (3) check 阶段</h5> <p>setImmediate()的回调会被加入 check 队列中，从 event loop 的阶段图可以知道，check 阶段的执行顺序在 poll 阶段之后。<br>
我们先来看个例子:</p> <div class="language- extra-class"><pre><code>console.log('start')
setTimeout(() =&gt; {
  console.log('timer1')
  Promise.resolve().then(function() {
    console.log('promise1')
  })
}, 0)
setTimeout(() =&gt; {
  console.log('timer2')
  Promise.resolve().then(function() {
    console.log('promise2')
  })
}, 0)
Promise.resolve().then(function() {
  console.log('promise3')
})
console.log('end')
//start=&gt;end=&gt;promise3=&gt;timer1=&gt;timer2=&gt;promise1=&gt;promise2
</code></pre></div><ul><li>一开始执行栈的同步任务（这属于宏任务）执行完毕后（依次打印出 start end，并将 2 个 timer 依次放入 timer 队列）,会先去执行微任务（<strong>这点跟浏览器端的一样</strong>），所以打印出 promise3</li> <li>然后进入 timers 阶段，执行 timer1 的回调函数，打印 timer1，并将 promise.then 回调放入 microtask 队列，同样的步骤执行 timer2，打印 timer2；这点跟浏览器端相差比较大，<strong>timers 阶段有几个 setTimeout/setInterval 都会依次执行</strong>，并不像浏览器端，每执行一个宏任务后就去执行一个微任务（关于 Node 与浏览器的 Event Loop 差异，下文还会详细介绍）。</li></ul> <h4 id="_3-micro-task-与-macro-task"><a href="#_3-micro-task-与-macro-task" class="header-anchor">#</a> 3.Micro-Task 与 Macro-Task</h4> <p>Node 端事件循环中的异步队列也是这两种：macro（宏任务）队列和 micro（微任务）队列。</p> <ul><li>常见的 macro-task 比如：setTimeout、setInterval、 setImmediate、script（整体代码）、 I/O 操作等。</li> <li>常见的 micro-task 比如: process.nextTick、new Promise().then(回调)等。</li></ul> <h4 id="_4-注意点"><a href="#_4-注意点" class="header-anchor">#</a> 4.注意点</h4> <h5 id="_1-settimeout-和-setimmediate"><a href="#_1-settimeout-和-setimmediate" class="header-anchor">#</a> (1) setTimeout 和 setImmediate</h5> <p>二者非常相似，区别主要在于调用时机不同。</p> <ul><li><p>setImmediate 设计在 poll 阶段完成时执行，即 check 阶段；</p></li> <li><p>setTimeout 设计在 poll 阶段为空闲时，且设定时间到达后执行，但它在 timer 阶段执行</p> <p>setTimeout(function timeout () {
console.log('timeout');
},0);
setImmediate(function immediate () {
console.log('immediate');
});</p></li></ul> <ul><li>对于以上代码来说，setTimeout 可能执行在前，也可能执行在后。</li> <li>首先 setTimeout(fn, 0) === setTimeout(fn, 1)，这是由源码决定的<br>
进入事件循环也是需要成本的，如果在准备时候花费了大于 1ms 的时间，那么在 timer 阶段就会直接执行 setTimeout 回调</li> <li>如果准备时间花费小于 1ms，那么就是 setImmediate 回调先执行了</li></ul> <p>但当二者在异步 i/o callback 内部调用时，总是先执行 setImmediate，再执行 setTimeout</p> <div class="language- extra-class"><pre><code>const fs = require('fs')
fs.readFile(__filename, () =&gt; {
    setTimeout(() =&gt; {
        console.log('timeout');
    }, 0)
    setImmediate(() =&gt; {
        console.log('immediate')
    })
})
// immediate
// timeout
</code></pre></div><p>在上述代码中，setImmediate 永远先执行。因为两个代码写在 IO 回调中，IO 回调是在 poll 阶段执行，当回调执行完毕后队列为空，发现存在 setImmediate 回调，所以就直接跳转到 check 阶段去执行回调了。</p> <h5 id="_2-process-nexttick"><a href="#_2-process-nexttick" class="header-anchor">#</a> (2) process.nextTick</h5> <p>这个函数其实是独立于 Event Loop 之外的，它有一个自己的队列，当每个阶段完成后，如果存在 nextTick 队列，就会清空队列中的所有回调函数，并且优先于其他 microtask 执行。</p> <div class="language- extra-class"><pre><code>setTimeout(() =&gt; {
 console.log('timer1')
 Promise.resolve().then(function() {
   console.log('promise1')
 })
}, 0)
process.nextTick(() =&gt; {
 console.log('nextTick')
 process.nextTick(() =&gt; {
   console.log('nextTick')
   process.nextTick(() =&gt; {
     console.log('nextTick')
     process.nextTick(() =&gt; {
       console.log('nextTick')
     })
   })
 })
})
// nextTick=&gt;nextTick=&gt;nextTick=&gt;nextTick=&gt;timer1=&gt;promise1
</code></pre></div><h3 id="node-与浏览器的-event-loop-差异"><a href="#node-与浏览器的-event-loop-差异" class="header-anchor">#</a> Node 与浏览器的 Event Loop 差异</h3> <p>浏览器环境下，microtask 的任务队列是每个 macrotask 执行完之后执行。而在 Node.js 中，microtask 会在事件循环的各个阶段之间执行，也就是一个阶段执行完毕，就会去执行 microtask 队列的任务</p> <p><img src="https://camo.githubusercontent.com/71b607cd363565c5d61299d31d9fd72b889de645/68747470733a2f2f757365722d676f6c642d63646e2e786974752e696f2f323031392f312f31322f313638343162616431636461373431663f773d3130353126683d33343426663d706e6726733d3932363835" alt=""></p> <p>接下我们通过一个例子来说明两者区别：</p> <div class="language- extra-class"><pre><code>setTimeout(()=&gt;{
    console.log('timer1')
    Promise.resolve().then(function() {
        console.log('promise1')
    })
}, 0)
setTimeout(()=&gt;{
    console.log('timer2')
    Promise.resolve().then(function() {
        console.log('promise2')
    })
}, 0)
</code></pre></div><p>浏览器端运行结果：<code>timer1=&gt;promise1=&gt;timer2=&gt;promise2</code></p> <p>浏览器端的处理过程如下：</p> <p><img src="https://camo.githubusercontent.com/b325e476f0336804b8bdbcd7e4e3674a52dfbd80/68747470733a2f2f757365722d676f6c642d63646e2e786974752e696f2f323031392f312f31322f313638343164363339326538663533373f773d36313126683d33343126663d67696626733d373232393739" alt=""></p> <p>Node 端运行结果分两种情况：</p> <ul><li><p>如果是 node11 版本一旦执行一个阶段里的一个宏任务(setTimeout,setInterval 和 setImmediate)就立刻执行微任务队列，这就跟浏览器端运行一致，最后的结果为<code>timer1=&gt;promise1=&gt;timer2=&gt;promise2</code></p></li> <li><p>如果是 node10 及其之前版本：要看第一个定时器执行完，第二个定时器是否在完成队列中。</p> <ul><li><p>如果是第二个定时器还未在完成队列中，最后的结果为<code>timer1=&gt;promise1=&gt;timer2=&gt;promise2</code></p></li> <li><p>如果是第二个定时器已经在完成队列中，则最后的结果为<code>timer1=&gt;timer2=&gt;promise1=&gt;promise2</code>(下文过程解释基于这种情况下)</p> <p>1.全局脚本（main()）执行，将 2 个 timer 依次放入 timer 队列，main()执行完毕，调用栈空闲，任务队列开始执行；</p> <p>2.首先进入 timers 阶段，执行 timer1 的回调函数，打印 timer1，并将 promise1.then 回调放入 microtask 队列，同样的步骤执行 timer2，打印 timer2；</p> <p>3.至此，timer 阶段执行结束，event loop 进入下一个阶段之前，执行 microtask 队列的所有任务，依次打印 promise1、promise2</p></li></ul></li></ul> <p>Node 端的处理过程如下：<br> <img src="https://camo.githubusercontent.com/34b3491060826045c67bd57c6dcf97222620a722/68747470733a2f2f757365722d676f6c642d63646e2e786974752e696f2f323031392f312f31322f313638343164356638353436383034373f773d35393826683d33333326663d67696626733d343637363635" alt=""></p> <p>浏览器和 Node 环境下，microtask 任务队列的执行时机不同</p> <ul><li>Node 端，microtask 在事件循环的各个阶段之间执行</li> <li>浏览器端，microtask 在事件循环的 macrotask 执行完之后执行</li></ul></div> <footer class="page-edit" style="display:none;"><!----> <!----></footer> <!----></main> <!----> <div style="display:none;" data-v-418054de data-v-418054de><div class="comments-wrapper" data-v-418054de><!----></div></div></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-1e128e82 data-v-1e128e82><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-1e128e82><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-1e128e82></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-1e128e82></path></svg></div></div></div>
    <script src="/assets/js/app.8e528a8b.js" defer></script><script src="/assets/js/3.82a49c19.js" defer></script><script src="/assets/js/1.0ab98803.js" defer></script><script src="/assets/js/16.695eba2a.js" defer></script>
  </body>
</html>
